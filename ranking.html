<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å½“é¸å ±å‘Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: 'Segoe UI', sans-serif;
      padding: 24px 16px;
      min-height: 100vh;
    }
    h1 { font-size: 1.4rem; margin-bottom: 4px; color: #f8fafc; }
    .subtitle { font-size: 0.8rem; color: #64748b; margin-bottom: 24px; }
    h2 { font-size: 1rem; color: #94a3b8; margin-bottom: 14px; letter-spacing: 0.05em; }
    .card { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px; }

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
    .rank-row { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
    .rank-num { width: 28px; text-align: center; font-size: 1.1rem; font-weight: 700; flex-shrink: 0; color: #94a3b8; }
    .rank-num.gold   { color: #fbbf24; }
    .rank-num.silver { color: #cbd5e1; }
    .rank-num.bronze { color: #d97706; }
    .rank-info { flex: 1; min-width: 0; }
    .rank-tag  { font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
    .bar-wrap  { height: 12px; background: #334155; border-radius: 6px; overflow: hidden; }
    .bar-fill  { height: 100%; border-radius: 6px; transition: width 0.7s ease; }
    .rank-meta { font-size: 0.72rem; color: #94a3b8; margin-top: 4px; }
    .new-badge {
      display: inline-block; background: #10b981; color: #fff;
      font-size: 0.65rem; font-weight: 700; padding: 1px 5px;
      border-radius: 4px; margin-left: 5px; vertical-align: middle;
    }

    /* ãƒãƒ£ãƒ¼ãƒˆ */
    #trend-canvas { width: 100%; border-radius: 6px; }
    .legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: #94a3b8; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .snap-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .snap-table th { color: #64748b; font-weight: 500; padding: 6px 8px; text-align: right; border-bottom: 1px solid #334155; }
    .snap-table th:first-child { text-align: left; }
    .snap-table td { padding: 6px 8px; text-align: right; border-bottom: 1px solid #1e293b; }
    .snap-table td:first-child { text-align: left; }
    .snap-table tr:last-child td { border-bottom: none; }
    .snap-time { font-size: 0.72rem; color: #64748b; margin-bottom: 10px; }
    .note { font-size: 0.72rem; color: #475569; margin-top: 10px; }

    #error { color: #f87171; font-size: 0.9rem; margin-top: 20px; }
  </style>
</head>
<body>

<h1>å½“é¸å ±å‘Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
<p class="subtitle" id="update-time">èª­ã¿è¾¼ã¿ä¸­...</p>
<div id="error" style="display:none"></div>

<!-- ç¾åœ¨ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
<div class="card">
  <h2>ç´¯è¨ˆå½“é¸å ±å‘Šæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
  <div id="rank-list"></div>
</div>

<!-- æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ -->
<div class="card">
  <h2>ç´¯è¨ˆå ±å‘Šæ•°ã®æ¨ç§»</h2>
  <canvas id="trend-canvas"></canvas>
  <div class="legend" id="legend"></div>
</div>

<!-- æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆè¡¨ -->
<div class="card">
  <h2>æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ</h2>
  <p class="snap-time" id="snap-time"></p>
  <table class="snap-table">
    <thead>
      <tr>
        <th>ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</th>
        <th>ç´¯è¨ˆå ±å‘Šæ•°</th>
        <th>ä»Šå›æ–°è¦</th>
      </tr>
    </thead>
    <tbody id="snap-tbody"></tbody>
  </table>
  <p class="note">â€» å„å–å¾—ã§ä¸Šä½100ä»¶ã®ã¿è¿½è·¡ã€‚å®Ÿéš›ã®æŠ•ç¨¿æ•°ã¯ã“ã‚Œã‚ˆã‚Šå¤šã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
</div>

<script>
const HISTORY_URL = 'data/tweets/ranking_history.json';

function fmtTime(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleString('ja-JP', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
  } catch { return iso; }
}

function showError(msg) {
  const el = document.getElementById('error');
  el.textContent = msg;
  el.style.display = '';
}

async function main() {
  let history;
  try {
    const res = await fetch(HISTORY_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    history = await res.json();
  } catch (e) {
    showError(`ranking_history.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(${e.message})`);
    return;
  }

  if (!history.length) { showError('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  const latest = history[history.length - 1];
  document.getElementById('update-time').textContent = `æœ€çµ‚æ›´æ–°: ${fmtTime(latest.ts)}`;

  const tags = Object.keys(latest.data).sort(
    (a, b) => latest.data[b].total_posts - latest.data[a].total_posts
  );

  // ---- ç¾åœ¨ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° ----
  const maxPosts = Math.max(...tags.map(t => latest.data[t].total_posts), 1);
  const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
  const rankClasses = ['gold', 'silver', 'bronze', '', ''];
  const list = document.getElementById('rank-list');

  tags.forEach((tag, i) => {
    const d = latest.data[tag];
    const pct = (d.total_posts / maxPosts * 100).toFixed(1);
    const newBadge = d.new_posts > 0
      ? `<span class="new-badge">+${d.new_posts}</span>` : '';
    const row = document.createElement('div');
    row.className = 'rank-row';
    row.innerHTML = `
      <div class="rank-num ${rankClasses[i]}">${medals[i] || i + 1}</div>
      <div class="rank-info">
        <div class="rank-tag" style="color:${d.color}">${tag}${newBadge}</div>
        <div class="bar-wrap">
          <div class="bar-fill" style="width:${pct}%;background:${d.color}"></div>
        </div>
        <div class="rank-meta">ç´¯è¨ˆ <strong>${d.total_posts}</strong> ä»¶</div>
      </div>`;
    list.appendChild(row);
  });

  // ---- æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ ----
  const canvas = document.getElementById('trend-canvas');
  const W = canvas.parentElement.clientWidth - 40;
  const H = Math.round(W * 0.4);
  canvas.width  = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');

  const PAD = { top: 12, right: 10, bottom: 28, left: 48 };
  const plotW = W - PAD.left - PAD.right;
  const plotH = H - PAD.top - PAD.bottom;

  const slice = history.slice(-96);  // ç›´è¿‘24æ™‚é–“
  const n = slice.length;
  const allVals = slice.flatMap(s => Object.values(s.data).map(d => d.total_posts));
  const yMax = Math.max(...allVals, 1);

  // ã‚°ãƒªãƒƒãƒ‰ç·š
  ctx.strokeStyle = '#334155';
  ctx.lineWidth = 1;
  [0, 0.25, 0.5, 0.75, 1].forEach(r => {
    const y = PAD.top + plotH * (1 - r);
    ctx.beginPath();
    ctx.moveTo(PAD.left, y);
    ctx.lineTo(PAD.left + plotW, y);
    ctx.stroke();
    ctx.fillStyle = '#64748b';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(yMax * r), PAD.left - 4, y + 3);
  });

  // æ™‚é–“è»¸ãƒ©ãƒ™ãƒ«
  ctx.fillStyle = '#64748b';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  const step = Math.max(1, Math.floor(n / 5));
  for (let i = 0; i < n; i += step) {
    const x = PAD.left + (i / Math.max(n - 1, 1)) * plotW;
    ctx.fillText(fmtTime(slice[i].ts), x, H - 4);
  }

  // æŠ˜ã‚Œç·š
  tags.forEach(tag => {
    const color = latest.data[tag]?.color || '#888';
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    slice.forEach((snap, i) => {
      const val = snap.data[tag]?.total_posts ?? 0;
      const x = PAD.left + (i / Math.max(n - 1, 1)) * plotW;
      const y = PAD.top + plotH * (1 - val / yMax);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();
  });

  // å‡¡ä¾‹
  const legend = document.getElementById('legend');
  tags.forEach(tag => {
    const color = latest.data[tag]?.color || '#888';
    legend.innerHTML += `
      <div class="legend-item">
        <div class="legend-dot" style="background:${color}"></div>
        <span>${tag}</span>
      </div>`;
  });

  // ---- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆè¡¨ ----
  document.getElementById('snap-time').textContent = `å–å¾—æ™‚åˆ»: ${fmtTime(latest.ts)}`;
  const tbody = document.getElementById('snap-tbody');
  tags.forEach(tag => {
    const d = latest.data[tag];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="color:${d.color}">${tag}</td>
      <td><strong>${d.total_posts}</strong></td>
      <td style="color:${d.new_posts > 0 ? '#10b981' : '#475569'}">
        ${d.new_posts > 0 ? '+' + d.new_posts : '-'}
      </td>`;
    tbody.appendChild(tr);
  });
}

main();
</script>
</body>
</html>
