<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W1ZF7NSXKT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-W1ZF7NSXKT');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒªãƒ‘ãƒˆãƒ¬ãƒ³ãƒ‰ | Cloveãƒ»DOPAãƒ»ã‚ªãƒªãã˜æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</title>
    <meta name="description" content="Cloveãƒ»DOPAãƒ»ã‚ªãƒªãã˜ãƒ»ã‚ªãƒªãƒ‘ãƒ¯ãƒ³ãƒ»æ—¥æœ¬ãƒˆãƒ¬ã‚«ã‚»ãƒ³ã‚¿ãƒ¼ã®æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å¯è¦–åŒ–ã€‚æœŸé–“æ¯”è¼ƒã¨Xå½“é¸å ±å‘Šãƒã‚¹ãƒˆã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¾ã¨ã‚ã¦ç¢ºèªã§ãã¾ã™ã€‚">
    <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1">
    <link rel="canonical" href="/">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ja_JP">
    <meta property="og:site_name" content="ã‚ªãƒªãƒ‘ãƒˆãƒ¬ãƒ³ãƒ‰">
    <meta property="og:title" content="ã‚ªãƒªãƒ‘ãƒˆãƒ¬ãƒ³ãƒ‰ | ã‚ªãƒªãƒ‘æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ">
    <meta property="og:description" content="ä¸»è¦ã‚ªãƒªãƒ‘ã‚µã‚¤ãƒˆã®æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰ã¨Xå½“é¸å ±å‘Šã‚’ä¸€ç”»é¢ã§ãƒã‚§ãƒƒã‚¯ã€‚">
    <meta property="og:url" content="/">
    <meta property="og:image" content="ogp.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ã‚ªãƒªãƒ‘ãƒˆãƒ¬ãƒ³ãƒ‰ | ã‚ªãƒªãƒ‘æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ">
    <meta name="twitter:description" content="ä¸»è¦ã‚ªãƒªãƒ‘ã‚µã‚¤ãƒˆã®æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰ã¨Xå½“é¸å ±å‘Šã‚’å¯è¦–åŒ–ã€‚">
    <meta name="twitter:image" content="ogp.png">
    <meta name="theme-color" content="#111315">
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Serif+JP:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "ã‚ªãƒªãƒ‘ãƒˆãƒ¬ãƒ³ãƒ‰",
      "url": "/",
      "inLanguage": "ja",
      "description": "ä¸»è¦ã‚ªãƒªãƒ‘ã‚µã‚¤ãƒˆã®æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰ã¨Xå½“é¸å ±å‘Šãƒã‚¹ãƒˆã‚’ç¢ºèªã§ãã‚‹åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€‚"
    }
    </script>
    <style>
        :root {
            --bg: #111315;
            --surface: rgba(255,255,255,0.03);
            --surface-hover: rgba(255,255,255,0.06);
            --border: rgba(255,255,255,0.10);
            --border-hover: rgba(212,175,55,0.35);
            --text: #ece7dc;
            --text-muted: #a39b8e;
            --text-dim: #c4bcad;
            --accent: #b79b5b;
            --accent-2: #8f7650;
            --lux-line: rgba(224,198,139,0.28);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            background-image:
                radial-gradient(ellipse 85% 55% at 15% 0%, rgba(183,155,91,0.10) 0%, transparent 62%),
                radial-gradient(ellipse 60% 45% at 90% 100%, rgba(120,102,71,0.12) 0%, transparent 65%);
            color: var(--text);
            min-height: 100vh;
            padding: 24px 20px;
            letter-spacing: 0.01em;
        }

        .container { max-width: 1240px; margin: auto; }

        /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 14px;
            position: relative;
        }
        .header::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--lux-line), transparent);
        }

        .header-left { display: flex; align-items: center; gap: 12px; }

        .header-icon {
            width: 38px; height: 38px;
            background: linear-gradient(135deg, #4c4338, #9f8558);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.35);
        }

        .header-title {
            font-size: 20px;
            font-weight: 800;
            font-family: 'Noto Serif JP', serif;
            background: linear-gradient(90deg, #f0ebe1 0%, #b5aa96 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.02em;
        }

        .header-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ */
        .seg-group {
            display: flex;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 3px;
            gap: 2px;
        }
        .seg {
            background: transparent;
            color: var(--text-muted);
            border: none;
            padding: 7px 18px;
            border-radius: 7px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
            font-family: inherit;
        }
        .seg.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: #1a1712;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .seg:hover:not(.active) { background: var(--surface-hover); color: var(--text); }

        select {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 7px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
        }
        select option {
            color: #1c1a16;
            background: #f3ede2;
        }
        select option:checked {
            color: #1c1a16;
            background: #d7c295;
        }

        /* ===== ã‚µã‚¤ãƒˆãƒªãƒ³ã‚¯ ===== */
        .site-links {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .site-link {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px;
            border-radius: 14px;
            text-decoration: none;
            background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            color: var(--text);
            border: 1px solid rgba(255,255,255,0.08);
            border-left: 3px solid color-mix(in srgb, var(--c) 75%, #ffffff 25%);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            box-shadow: 0 4px 14px rgba(0,0,0,0.35);
        }
        .site-link::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 60%);
            pointer-events: none;
        }
        .site-link:hover {
            transform: translateY(-3px);
            border-color: var(--border-hover);
            box-shadow: 0 12px 26px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.08);
        }
        .site-link .site-name { display: block; font-size: 14px; font-weight: 700; letter-spacing: 0.02em; }
        .site-link .site-url  { display: block; font-size: 10px; opacity: 0.72; margin-top: 3px; font-weight: 500; }
        .site-link::after { content: 'â†’'; font-size: 14px; opacity: 0.7; flex-shrink: 0; margin-left: 8px; }

        @media (max-width: 700px) { .site-links { grid-template-columns: repeat(2, 1fr); } }

        /* ===== AIãƒ‘ãƒãƒ« ===== */
        .ai-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 14px 18px;
            margin-bottom: 24px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-dim);
            backdrop-filter: blur(8px);
        }
        .ai-panel b { color: var(--text); }
        .ai-panel.error { border-left-color: #ef4444; }

        /* ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€š ===== */
        .section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 22px 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(8px);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.04), 0 10px 28px rgba(0,0,0,0.22);
        }

        .section-title {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Noto Serif JP', serif;
        }
        .section-title::before {
            content: '';
            display: block;
            width: 3px;
            height: 12px;
            border-radius: 2px;
            background: linear-gradient(to bottom, var(--accent), var(--accent-2));
        }

        /* ===== ãƒãƒ£ãƒ¼ãƒˆã‚°ãƒªãƒƒãƒ‰ ===== */
        .chart-grid { display: grid; grid-template-columns: 1fr; grid-template-rows: 420px 56px; gap: 10px; }

        .x-ctrl {
            grid-column: 1 / -1;
            background: rgba(0,0,0,0.25);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 16px;
        }
        .x-reset {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-dim);
            border-radius: 6px;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            font-family: inherit;
            transition: all 0.15s;
        }
        .x-reset:hover {
            background: var(--surface-hover);
            color: var(--text);
            border-color: var(--border-hover);
        }

        .dual-range { position: relative; flex: 1; height: 20px; display: flex; align-items: center; }
        .dual-range input[type="range"] {
            position: absolute; width: 100%; height: 0;
            background: none; pointer-events: none;
            appearance: none; -webkit-appearance: none;
        }
        .dual-range input[type="range"]::-webkit-slider-thumb {
            pointer-events: all; -webkit-appearance: none;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--accent); border: 2px solid #f0ebe1;
            cursor: pointer; box-shadow: 0 0 0 2px rgba(183,155,91,0.2);
        }
        .dual-range input[type="range"]::-moz-range-thumb {
            pointer-events: all; width: 16px; height: 16px; border-radius: 50%;
            background: var(--accent); border: 2px solid #f0ebe1;
            cursor: pointer; box-shadow: 0 0 0 2px rgba(183,155,91,0.2);
        }
        .range-track { position: absolute; width: 100%; height: 3px; background: rgba(255,255,255,0.08); border-radius: 2px; }
        .range-fill  { position: absolute; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius: 2px; }

        .chart-wrap {
            position: relative;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
        }
        .chart-wrap::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(80% 120% at 12% 8%, rgba(183,155,91,0.10), transparent 60%),
                linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.05));
            pointer-events: none;
            z-index: 0;
        }
        .chart-wrap canvas { position: relative; z-index: 1; }

        .loading-overlay {
            display: none; position: absolute; inset: 0;
            background: rgba(6,13,26,0.8);
            align-items: center; justify-content: center;
            flex-direction: column; gap: 10px;
            border-radius: 12px; z-index: 10;
            backdrop-filter: blur(4px);
        }
        .loading-overlay.show { display: flex; }
        .loading-text { font-size: 13px; color: var(--text-muted); }

        /* ===== ãƒ„ã‚¤ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ ===== */
        .tweet-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .tweet-fetched { font-size: 11px; color: var(--text-muted); }

        .tweet-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 14px; }

        .tweet-card {
            position: relative;
            background: rgba(255,255,255,0.03);
            border-radius: 14px;
            padding: 18px;
            border: 1px solid var(--border);
            display: block;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .tweet-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.04) 0%, transparent 60%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tweet-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 14px 32px rgba(0,0,0,0.48), inset 0 1px 0 rgba(255,255,255,0.06);
            border-color: var(--border-hover);
        }
        .tweet-card:hover::before { opacity: 1; }

        .tweet-card .card-header { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .tweet-card .tag {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 9px;
            border-radius: 20px;
            color: #fff;
            letter-spacing: 0.02em;
        }

        .rank-badge { font-size: 15px; font-weight: 700; }
        .rank-other { font-size: 12px; color: rgba(255,255,255,0.2); font-weight: 600; }

        .hot-badge {
            font-size: 10px;
            font-weight: 700;
            background: linear-gradient(90deg, #7f2f2f, #a05b3a);
            color: #fff;
            padding: 2px 8px;
            border-radius: 20px;
            letter-spacing: 0.02em;
        }

        .tweet-card .author-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .tweet-card .avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: rgba(255,255,255,0.08); border: 1px solid var(--border); }
        .tweet-card .author-info { display: flex; flex-direction: column; min-width: 0; flex: 1; }
        .tweet-card .author-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tweet-card .author-handle { font-size: 11px; color: var(--text-muted); }

        .likes-big { margin-left: auto; color: #d5a97a; font-weight: 700; white-space: nowrap; flex-shrink: 0; line-height: 1; text-align: right; }
        .likes-big .likes-num { font-size: 20px; display: block; }
        .likes-big .likes-label { font-size: 10px; opacity: 0.7; }

        .tweet-card .text { font-size: 13px; line-height: 1.65; color: #cbd5e1; margin-bottom: 10px; word-break: break-word; }

        .tweet-card .images { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; }
        .tweet-card .images img { width: calc(50% - 2px); border-radius: 8px; object-fit: cover; max-height: 180px; cursor: zoom-in; transition: opacity 0.15s; }
        .tweet-card .images img:hover { opacity: 0.85; }
        .tweet-card .images img:only-child { width: 100%; }

        .tweet-card .meta { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        .tweet-card .meta::before { content: 'ğŸ•'; font-size: 10px; }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ– */
        .tweet-filter { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 16px; }
        .filter-tab {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }
        .filter-tab:hover:not(.active) { background: var(--surface-hover); color: var(--text); border-color: var(--border-hover); }
        .filter-tab.active { color: #fff; border-color: transparent; box-shadow: 0 0 10px rgba(255,255,255,0.1); }

        .tweet-no-data { font-size: 13px; color: var(--text-muted); padding: 20px 0; text-align: center; }

        .image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.82);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 28px;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .image-modal.show { display: flex; }
        .image-modal img {
            max-width: min(1100px, 95vw);
            max-height: 88vh;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.22);
            box-shadow: 0 24px 60px rgba(0,0,0,0.55);
            object-fit: contain;
            background: #0f1113;
        }
        .image-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(20,20,20,0.75);
            color: #fff;
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
        }
        .image-modal-close:hover { border-color: var(--border-hover); }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 640px) {
            body { padding: 12px 10px; }
            .header-title { font-size: 17px; }
            .chart-grid { grid-template-columns: 1fr; grid-template-rows: 300px 52px; gap: 6px; }
        }

    /* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
    .rnk-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 22px 24px; margin-bottom: 16px; backdrop-filter: blur(8px); box-shadow: inset 0 1px 0 rgba(255,255,255,0.04), 0 10px 28px rgba(0,0,0,0.22); }
    .rnk-rank-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
    .rnk-rank-num { width: 28px; text-align: center; font-size: 1.1rem; font-weight: 700; flex-shrink: 0; color: var(--text-muted); }
    .rnk-rank-num.gold   { color: #c9a84c; }
    .rnk-rank-num.silver { color: #a8a49c; }
    .rnk-rank-num.bronze { color: #9b7a4a; }
    .rnk-rank-info { flex: 1; min-width: 0; }
    .rnk-rank-tag  { font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
    .rnk-bar-wrap  { height: 8px; background: rgba(255,255,255,0.07); border-radius: 4px; overflow: hidden; }
    .rnk-bar-fill  { height: 100%; border-radius: 4px; transition: width 0.7s ease; }
    .rnk-rank-meta { font-size: 0.72rem; color: var(--text-muted); margin-top: 5px; }
    .rnk-new-badge { display: inline-block; background: #10b981; color: #fff; font-size: 0.65rem; font-weight: 700; padding: 1px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
    #rnk-trend-canvas { width: 100%; border-radius: 6px; }
    .rnk-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 14px; }
    .rnk-legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: var(--text-muted); }
    .rnk-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .rnk-snap-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .rnk-snap-table th { color: var(--text-muted); font-weight: 600; font-size: 0.72rem; letter-spacing: 0.05em; padding: 6px 8px; text-align: right; border-bottom: 1px solid var(--lux-line); }
    .rnk-snap-table th:first-child { text-align: left; }
    .rnk-snap-table td { padding: 8px 8px; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text-dim); }
    .rnk-snap-table td:first-child { text-align: left; }
    .rnk-snap-table tr:last-child td { border-bottom: none; }
    .rnk-snap-time { font-size: 0.72rem; color: var(--text-muted); margin-bottom: 12px; }
    .rnk-note { font-size: 0.72rem; color: var(--text-muted); opacity: 0.6; margin-top: 12px; }
    .rnk-update-time { font-size: 0.72rem; color: var(--text-muted); margin-bottom: 16px; }
    </style>
</head>
<body>

<div class="container">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="header-left">
            <div class="header-icon">ğŸ“ˆ</div>
            <div>
                <h1 class="header-title">ã‚ªãƒªãƒ‘ãƒˆãƒ¬ãƒ³ãƒ‰</h1>
                <div class="header-sub">2025/11ã€œ | æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰ &amp; å½“é¸å ±å‘Š</div>
            </div>
        </div>
        <div class="toolbar">
            <div class="seg-group">
                <button id="btn-weekly" class="seg active" onclick="loadAllDaily()">å…¨æœŸé–“</button>
                <button id="btn-daily"  class="seg"        onclick="onDailyClick()">æœˆåˆ¥</button>
            </div>
            <select id="month-select" style="display:none" onchange="loadMonthly()">
                <option value="">æœˆã‚’é¸æŠ</option>
            </select>
        </div>
    </div>

    <!-- ã‚µã‚¤ãƒˆãƒªãƒ³ã‚¯ -->
    <div class="site-links">
        <a class="site-link" href="https://oripa.clove.jp/oripa/All" target="_blank" rel="noopener" style="--c:#f43f5e"><span><span class="site-name">Clove</span><span class="site-url">oripa.clove.jp</span></span></a>
        <a class="site-link" href="https://orikuji.com/"             target="_blank" rel="noopener" style="--c:#f59e0b"><span><span class="site-name">ã‚ªãƒªãã˜</span><span class="site-url">orikuji.com</span></span></a>
        <a class="site-link" href="https://dopa-game.jp/"            target="_blank" rel="noopener" style="--c:#10b981"><span><span class="site-name">DOPA</span><span class="site-url">dopa-game.jp</span></span></a>
        <a class="site-link" href="https://oripaone.jp/"             target="_blank" rel="noopener" style="--c:#3b82f6"><span><span class="site-name">ã‚ªãƒªãƒ‘ãƒ¯ãƒ³</span><span class="site-url">oripaone.jp</span></span></a>
        <a class="site-link" href="https://japan-toreca.com/"        target="_blank" rel="noopener" style="--c:#8b5cf6"><span><span class="site-name">æ—¥æœ¬ãƒˆãƒ¬ã‚«ã‚»ãƒ³ã‚¿ãƒ¼</span><span class="site-url">japan-toreca.com</span></span></a>
    </div>

    <!-- AIãƒ‘ãƒãƒ« -->
    <div id="ai-news" class="ai-panel">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...</div>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ -->
    <div class="section">
        <div class="section-title">æ¤œç´¢ãƒˆãƒ¬ãƒ³ãƒ‰</div>
        <div class="chart-grid">
            <div class="chart-wrap">
                <canvas id="mainChart"></canvas>
                <div class="loading-overlay" id="loading-overlay">
                    <span class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </div>
            <div class="x-ctrl">
                <button class="x-reset" onclick="resetX()">å…¨è¡¨ç¤º</button>
                <div class="dual-range">
                    <div class="range-track"><div class="range-fill" id="range-fill"></div></div>
                    <input type="range" id="x-start" min="0" max="100" value="0"   oninput="onDualRange('start')">
                    <input type="range" id="x-end"   min="0" max="100" value="100" oninput="onDualRange('end')">
                </div>
            </div>
        </div>
    </div>

    <!-- æ£’ã‚°ãƒ©ãƒ• -->
    <div class="section">
        <div class="section-title">å¹³å‡ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆè¡¨ç¤ºæœŸé–“ï¼‰</div>
        <div style="position:relative; height:175px;">
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <!-- X å½“é¸å ±å‘Šãƒã‚¹ãƒˆ -->
    <div class="section">
        <div class="section-title">X å½“é¸å ±å‘Šãƒã‚¹ãƒˆ</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;">
            <a href="https://x.com/search?q=%23Cloveå½“é¸å ±å‘Š&f=live" target="_blank" rel="noopener"
               class="site-link" style="--c:#f43f5e">
                <span><span class="site-name">#Cloveå½“é¸å ±å‘Š</span><span class="site-url">x.com ã§æ¤œç´¢</span></span>
            </a>
            <a href="https://x.com/search?q=%23ã‚ªãƒªãã˜å½“é¸å ±å‘Š&f=live" target="_blank" rel="noopener"
               class="site-link" style="--c:#f59e0b">
                <span><span class="site-name">#ã‚ªãƒªãã˜å½“é¸å ±å‘Š</span><span class="site-url">x.com ã§æ¤œç´¢</span></span>
            </a>
            <a href="https://x.com/search?q=%23DOPAå½“é¸å ±å‘Š&f=live" target="_blank" rel="noopener"
               class="site-link" style="--c:#10b981">
                <span><span class="site-name">#DOPAå½“é¸å ±å‘Š</span><span class="site-url">x.com ã§æ¤œç´¢</span></span>
            </a>
            <a href="https://x.com/search?q=%23ã‚ªãƒªãƒ‘ãƒ¯ãƒ³å½“é¸å ±å‘Š&f=live" target="_blank" rel="noopener"
               class="site-link" style="--c:#3b82f6">
                <span><span class="site-name">#ã‚ªãƒªãƒ‘ãƒ¯ãƒ³å½“é¸å ±å‘Š</span><span class="site-url">x.com ã§æ¤œç´¢</span></span>
            </a>
            <a href="https://x.com/search?q=%23ãƒˆãƒ¬ã‚«ã‚»ãƒ³ã‚¿ãƒ¼å½“é¸å ±å‘Š&f=live" target="_blank" rel="noopener"
               class="site-link" style="--c:#8b5cf6">
                <span><span class="site-name">#ãƒˆãƒ¬ã‚«ã‚»ãƒ³ã‚¿ãƒ¼å½“é¸å ±å‘Š</span><span class="site-url">x.com ã§æ¤œç´¢</span></span>
            </a>
        </div>
    </div>

    <!-- å½“é¸å ±å‘Šæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="section">
        <div class="section-title">å½“é¸å ±å‘Šæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
        <p class="rnk-update-time" id="rnk-update-time"></p>

        <div class="rnk-card">
            <div class="section-title" style="font-size:0.85rem;margin-bottom:14px;">ç´¯è¨ˆå½“é¸å ±å‘Šæ•°</div>
            <div id="rnk-rank-list"></div>
        </div>

        <div class="rnk-card">
            <div class="section-title" style="font-size:0.85rem;margin-bottom:14px;">ç´¯è¨ˆå ±å‘Šæ•°ã®æ¨ç§»</div>
            <canvas id="rnk-trend-canvas"></canvas>
            <div class="rnk-legend" id="rnk-legend"></div>
        </div>

        <div class="rnk-card">
            <div class="section-title" style="font-size:0.85rem;margin-bottom:14px;">æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ</div>
            <p class="rnk-snap-time" id="rnk-snap-time"></p>
            <table class="rnk-snap-table">
                <thead>
                    <tr>
                        <th>ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</th>
                        <th>ç´¯è¨ˆå ±å‘Šæ•°</th>
                        <th>ä»Šå›æ–°è¦</th>
                    </tr>
                </thead>
                <tbody id="rnk-snap-tbody"></tbody>
            </table>
            <p class="rnk-note">â€» å„å–å¾—ã§ä¸Šä½100ä»¶ã®ã¿è¿½è·¡ã€‚å®Ÿéš›ã®æŠ•ç¨¿æ•°ã¯ã“ã‚Œã‚ˆã‚Šå¤šã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>
    </div>

</div>

<div id="image-modal" class="image-modal" aria-hidden="true">
    <button id="image-modal-close" class="image-modal-close" aria-label="Close image">&times;</button>
    <img id="image-modal-img" src="" alt="">
</div>

<script>
let chart;
let barChart;
let currentData = null;
let isDaily = false;

const siteColors = {
    "Clove": "#f43f5e", "ã‚ªãƒªãƒ‘ãƒ¯ãƒ³": "#3b82f6",
    "DOPA": "#10b981", "ã‚ªãƒªãã˜": "#f59e0b", "æ—¥æœ¬ãƒˆãƒ¬ã‚«ã‚»ãƒ³ã‚¿ãƒ¼": "#8b5cf6"
};

const SITE_ORDER = ["Clove", "ã‚ªãƒªãã˜", "DOPA", "ã‚ªãƒªãƒ‘ãƒ¯ãƒ³", "æ—¥æœ¬ãƒˆãƒ¬ã‚«ã‚»ãƒ³ã‚¿ãƒ¼"];
const TWEET_TAG_ORDER = ["#Cloveå½“é¸å ±å‘Š", "#ã‚ªãƒªãã˜å½“é¸å ±å‘Š", "#DOPAå½“é¸å ±å‘Š", "#ã‚ªãƒªãƒ‘ãƒ¯ãƒ³å½“é¸å ±å‘Š", "#æ—¥æœ¬ãƒˆãƒ¬ã‚«ã‚»ãƒ³ã‚¿ãƒ¼å½“é¸å ±å‘Š"];

const chartTheme = {
    tick: '#a99879',
    gridMajor: 'rgba(226,198,139,0.12)',
    gridMinor: 'rgba(255,255,255,0.035)',
    axisBorder: 'rgba(226,198,139,0.28)',
    legend: '#c9bda6',
    tooltipBg: 'rgba(12,14,18,0.96)',
    tooltipBorder: 'rgba(226,198,139,0.34)',
    tooltipTitle: '#d6c8ae',
    tooltipText: '#f2eadc'
};

function hexToRgba(hex, alpha) {
    const raw = String(hex || '').replace('#', '');
    if (raw.length !== 6) return `rgba(100,116,139,${alpha})`;
    const r = parseInt(raw.slice(0, 2), 16);
    const g = parseInt(raw.slice(2, 4), 16);
    const b = parseInt(raw.slice(4, 6), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

const luxuryChartBg = {
    id: 'luxuryChartBg',
    beforeDraw(chart) {
        const { ctx, chartArea } = chart;
        if (!chartArea) return;
        const { left, top, width, height } = chartArea;

        ctx.save();
        const base = ctx.createLinearGradient(0, top, 0, top + height);
        base.addColorStop(0, 'rgba(22,24,28,0.82)');
        base.addColorStop(0.62, 'rgba(14,16,20,0.68)');
        base.addColorStop(1, 'rgba(10,12,15,0.84)');
        ctx.fillStyle = base;
        ctx.fillRect(left, top, width, height);

        const glow = ctx.createRadialGradient(
            left + width * 0.16, top + height * 0.24, 8,
            left + width * 0.16, top + height * 0.24, width * 0.86
        );
        glow.addColorStop(0, 'rgba(183,155,91,0.10)');
        glow.addColorStop(1, 'rgba(183,155,91,0)');
        ctx.fillStyle = glow;
        ctx.fillRect(left, top, width, height);
        ctx.restore();
    }
};

function sortSites(sites) {
    return [...sites].sort((a, b) => {
        const ai = SITE_ORDER.indexOf(a);
        const bi = SITE_ORDER.indexOf(b);
        return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
    });
}

// ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----

function setLoading(on) {
    document.getElementById('loading-overlay').classList.toggle('show', on);
}

function setError(msg) {
    const el = document.getElementById('ai-news');
    el.className = 'ai-panel error';
    el.innerHTML = `<b>âš  ã‚¨ãƒ©ãƒ¼:</b> ${msg}`;
}

function resetX() {
    document.getElementById('x-start').value = 0;
    document.getElementById('x-end').value   = 100;
    updateRangeFill();
    draw();
}

function updateRangeFill() {
    const s = parseInt(document.getElementById('x-start').value);
    const e = parseInt(document.getElementById('x-end').value);
    const fill = document.getElementById('range-fill');
    fill.style.left  = s + '%';
    fill.style.width = (e - s) + '%';
}

function onDualRange(which) {
    let s = parseInt(document.getElementById('x-start').value);
    let e = parseInt(document.getElementById('x-end').value);
    const MIN_GAP = 5;
    if (s > e - MIN_GAP) {
        if (which === 'start') { s = e - MIN_GAP; document.getElementById('x-start').value = s; }
        else                   { e = s + MIN_GAP; document.getElementById('x-end').value   = e; }
    }
    updateRangeFill();
    draw();
}


// ---- UI åˆ‡ã‚Šæ›¿ãˆ ----

function onDailyClick() {
    document.getElementById('btn-weekly').classList.remove('active');
    document.getElementById('btn-daily').classList.add('active');
    document.getElementById('month-select').style.display = '';
}

// ---- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ----

async function init() {
    try {
        const res = await fetch('data/trends/available_months.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const months = await res.json();
        const select = document.getElementById('month-select');
        months.forEach(m => {
            const [y, mm] = m.split('_');
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = `${y}å¹´ ${parseInt(mm)}æœˆ`;
            select.appendChild(opt);
        });
        loadAllDaily();
    } catch (e) {
        setError("ç›®æ¬¡ãƒ•ã‚¡ã‚¤ãƒ«(available_months.json)ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Pythonã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    }
}

async function loadAllDaily() {
    isDaily = true;
    document.getElementById('btn-weekly').classList.add('active');
    document.getElementById('btn-daily').classList.remove('active');
    document.getElementById('month-select').style.display = 'none';
    document.getElementById('month-select').value = '';
    document.getElementById('x-start').value = 0;
    document.getElementById('x-end').value   = 100;
    updateRangeFill();
    document.getElementById('ai-news').className = 'ai-panel';

    setLoading(true);
    try {
        const res = await fetch('data/trends/available_months.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const months = await res.json();
        const sorted = [...months].reverse();
        const jsons = await Promise.all(
            sorted.map(m => fetch(`data/trends/trends_${m}.json`).then(r => {
                if (!r.ok) throw new Error(`${m}: HTTP ${r.status}`);
                return r.json();
            }))
        );
        const merged = {};
        jsons.forEach(json => {
            const data = json.daily;
            Object.keys(data).forEach(kw => {
                if (!merged[kw]) merged[kw] = {};
                Object.assign(merged[kw], data[kw]);
            });
        });
        currentData = merged;
        draw(true);
    } catch (e) {
        setError(`å…¨æœŸé–“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${e.message})`);
    } finally {
        setLoading(false);
    }
}

async function loadMaster() {
    isDaily = false;
    document.getElementById('btn-weekly').classList.add('active');
    document.getElementById('btn-daily').classList.remove('active');
    document.getElementById('month-select').style.display = 'none';
    document.getElementById('month-select').value = '';
    document.getElementById('x-start').value = 0;
    document.getElementById('x-end').value   = 100;
    updateRangeFill();
    document.getElementById('ai-news').className = 'ai-panel';
    setLoading(true);
    try {
        const res = await fetch('data/trends/trends_master.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        currentData = json.weekly;
        draw(true);
    } catch (e) {
        setError(`ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${e.message})`);
    } finally {
        setLoading(false);
    }
}

async function loadMonthly() {
    const val = document.getElementById('month-select').value;
    if (!val) return;
    isDaily = true;
    document.getElementById('x-start').value = 0;
    document.getElementById('x-end').value   = 100;
    updateRangeFill();
    document.getElementById('ai-news').className = 'ai-panel';
    setLoading(true);
    try {
        const res = await fetch(`data/trends/trends_${val}.json`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        currentData = json.daily;
        draw(true);
    } catch (e) {
        setError(`æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${e.message})`);
    } finally {
        setLoading(false);
    }
}

// ---- æç”» ----

function draw(forceRecreate = false) {
    if (!currentData) return;

    const sites = sortSites(Object.keys(currentData));
    const times = Object.keys(currentData[sites[0]]).map(t => parseInt(t)).sort((a, b) => a - b);
    const xStart = parseInt(document.getElementById('x-start').value);
    const xEnd   = parseInt(document.getElementById('x-end').value);
    const startIdx = Math.floor((times.length - 1) * (xStart / 100));
    const endIdx   = Math.ceil((times.length - 1)  * (xEnd   / 100));
    const finalTimes = times.slice(startIdx, endIdx + 1);
    const yMax = 100;

    const labels = finalTimes.map(t => {
        const d = new Date(t);
        return `${d.getMonth() + 1}/${d.getDate()}`;
    });

    const datasets = sites.map(name => ({
        label: name,
        data: finalTimes.map(t => currentData[name][t.toString()]),
        borderColor: siteColors[name] || '#64748b',
        backgroundColor: (ctx) => {
            const base = siteColors[name] || '#64748b';
            const chartArea = ctx.chart.chartArea;
            if (!chartArea) return hexToRgba(base, 0.18);
            const grad = ctx.chart.ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            grad.addColorStop(0, hexToRgba(base, 0.32));
            grad.addColorStop(0.55, hexToRgba(base, 0.12));
            grad.addColorStop(1, hexToRgba(base, 0.00));
            return grad;
        },
        fill: true,
        tension: 0.34,
        pointRadius: 2.4,
        pointHoverRadius: 6,
        pointBackgroundColor: '#efe7d8',
        pointBorderColor: siteColors[name] || '#64748b',
        pointBorderWidth: 1.8,
        borderWidth: 3
    }));

    if (chart && !forceRecreate) {
        chart.data.labels = labels;
        chart.data.datasets.forEach((ds, i) => { ds.data = datasets[i].data; });
        chart.options.scales.y.max = yMax;
        chart.update('none');
    } else {
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('mainChart'), {
            plugins: [luxuryChartBg],
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: yMax,
                        border: { color: chartTheme.axisBorder },
                        grid: { color: chartTheme.gridMinor },
                        ticks: { color: chartTheme.tick, font: { size: 11, weight: 600 } }
                    },
                    x: {
                        border: { color: chartTheme.axisBorder },
                        grid: { color: chartTheme.gridMajor, lineWidth: 0.6, drawTicks: false },
                        ticks: {
                            color: chartTheme.tick,
                            font: { size: 11, weight: 600 },
                            maxTicksLimit: isDaily ? 15 : 10,
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: chartTheme.legend,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            pointStyleWidth: 12,
                            padding: 20,
                            font: { size: 12, weight: 600 }
                        }
                    },
                    tooltip: {
                        backgroundColor: chartTheme.tooltipBg,
                        borderColor: chartTheme.tooltipBorder,
                        borderWidth: 1,
                        titleColor: chartTheme.tooltipTitle,
                        bodyColor: chartTheme.tooltipText,
                        padding: 12,
                        cornerRadius: 12,
                        callbacks: {
                            label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y}`
                        }
                    }
                }
            }
        });
    }

    const lastT = finalTimes[finalTimes.length - 1];
    const top = sites.map(s => ({ n: s, v: currentData[s][lastT] })).sort((a, b) => b.v - a.v)[0];
    const panel = document.getElementById('ai-news');
    panel.className = 'ai-panel';
    panel.innerHTML = `<b>ã€ãƒãƒ¼ã‚±ãƒƒãƒˆè§£æã€‘</b> ${isDaily ? 'å…¨æœŸé–“' : 'æœˆåˆ¥'}è¡¨ç¤ºã€‚ç¾åœ¨ <b>${top.n}</b> ãŒã‚¹ã‚³ã‚¢ <b>${top.v}</b> ã§ãƒãƒ¼ã‚±ãƒƒãƒˆã‚’ç‰½å¼•ã—ã¦ã„ã¾ã™ã€‚`;

    drawBar(sites, finalTimes);
}

function drawBar(sites, finalTimes) {
    const ranked = sites.map(name => {
        const vals = finalTimes.map(t => currentData[name][t.toString()] ?? 0);
        const avg = Math.round(vals.reduce((a, b) => a + b, 0) / vals.length);
        return { name, avg };
    }).sort((a, b) => b.avg - a.avg);

    const labels   = ranked.map(r => r.name);
    const values   = ranked.map(r => r.avg);
    const bgColors = ranked.map(r => hexToRgba(siteColors[r.name] || '#64748b', 0.58));
    const bdColors = ranked.map(r => siteColors[r.name] || '#64748b');

    if (barChart) {
        barChart.data.labels                      = labels;
        barChart.data.datasets[0].data            = values;
        barChart.data.datasets[0].backgroundColor = bgColors;
        barChart.data.datasets[0].borderColor     = bdColors;
        barChart.update('none');
    } else {
        barChart = new Chart(document.getElementById('barChart'), {
            plugins: [luxuryChartBg],
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors,
                    borderColor: bdColors,
                    borderWidth: 1.2,
                    borderRadius: 7,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: chartTheme.tooltipBg,
                        borderColor: chartTheme.tooltipBorder,
                        borderWidth: 1,
                        titleColor: chartTheme.tooltipTitle,
                        bodyColor: chartTheme.tooltipText,
                        cornerRadius: 12,
                        callbacks: { label: ctx => ` å¹³å‡ã‚¹ã‚³ã‚¢: ${ctx.parsed.x}` }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: 100,
                        border: { color: chartTheme.axisBorder },
                        grid: { color: chartTheme.gridMinor },
                        ticks: { color: chartTheme.tick, font: { size: 11, weight: 600 } }
                    },
                    y: {
                        border: { color: chartTheme.axisBorder },
                        grid: { display: false },
                        ticks: { color: chartTheme.legend, font: { weight: '600', size: 12 } }
                    }
                }
            }
        });
    }
}

// ---- X ãƒã‚¹ãƒˆè¡¨ç¤º ----

let allPosts = [];
let currentFilter = 'all';
const HOT_THRESHOLD = 30;
let imageModalEl = null;
let imageModalImgEl = null;

async function loadTweets() {
    try {
        const res = await fetch('data/tweets/tweets.json');
        if (!res.ok) {
            document.getElementById('tweet-cards').innerHTML =
                '<div class="tweet-no-data">tweets.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚fetch_tweets.py ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>';
            return;
        }
        const data = await res.json();
        renderTweets(data);
    } catch (e) {
        console.error('loadTweets error:', e);
        document.getElementById('tweet-cards').innerHTML =
            `<div class="tweet-no-data">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
    }
}

function renderTweets(data) {
    const hashtags = data.hashtags || {};
    const keys = Object.keys(hashtags);
    if (keys.length === 0) return;

    if (data.fetched_at) {
        const d = new Date(data.fetched_at);
        document.getElementById('tweet-fetched').textContent =
            `å–å¾—: ${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    allPosts = [];
    keys.forEach(tag => {
        const posts = hashtags[tag].latest || [];
        const color = hashtags[tag].color || '#64748b';
        posts.forEach(p => allPosts.push({ tag, color, post: p }));
    });
    allPosts.sort((a, b) => b.post.likes - a.post.likes);

    currentFilter = 'all';
    buildFilterTabs(keys, hashtags);
    renderFilteredPosts();
}

function buildFilterTabs(keys, hashtags) {
    const container = document.getElementById('tweet-filter');
    container.innerHTML = '';

    const makeTab = (label, value, color) => {
        const btn = document.createElement('button');
        btn.className = 'filter-tab' + (currentFilter === value ? ' active' : '');
        btn.textContent = label;
        if (color && currentFilter === value) btn.style.background = color;
        btn.onclick = () => {
            currentFilter = value;
            container.querySelectorAll('.filter-tab').forEach(t => {
                t.classList.remove('active');
                t.style.background = '';
            });
            btn.classList.add('active');
            if (color) btn.style.background = color;
            renderFilteredPosts();
        };
        return btn;
    };

    container.appendChild(makeTab('ã™ã¹ã¦', 'all', null));
    const sortedKeys = [...keys].sort((a, b) => {
        const ai = TWEET_TAG_ORDER.indexOf(a);
        const bi = TWEET_TAG_ORDER.indexOf(b);
        return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
    });
    sortedKeys.forEach(tag => {
        container.appendChild(makeTab(tag, tag, hashtags[tag].color));
    });
}

function renderFilteredPosts() {
    const container = document.getElementById('tweet-cards');
    container.innerHTML = '';

    const filtered = currentFilter === 'all'
        ? allPosts
        : allPosts.filter(item => item.tag === currentFilter);

    if (filtered.length === 0) {
        container.innerHTML = '<div class="tweet-no-data">ãƒã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        return;
    }

    filtered.forEach(({ tag, color, post: p }, idx) => {
        const rank = idx + 1;
        const rankLabel = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
        const rankClass = rank <= 3 ? '' : 'rank-other';
        const hotBadge = p.likes >= HOT_THRESHOLD ? '<span class="hot-badge">ğŸ”¥ HOT</span>' : '';

        const d = p.created_at ? new Date(p.created_at) : null;
        const dateStr = d
            ? `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`
            : '';
        const url = `https://x.com/${p.author_username}/status/${p.id}`;

        const card = document.createElement('a');
        card.className = 'tweet-card';
        card.href = url;
        card.target = '_blank';
        card.rel = 'noopener';

        const avatarHtml = p.author_image
            ? `<img class="avatar" src="${p.author_image}" alt="" loading="lazy" onerror="this.style.display='none'">`
            : `<div class="avatar"></div>`;
        const imagesHtml = (p.images && p.images.length)
            ? `<div class="images">${p.images.map(src =>
                `<img class="tweet-image" src="${src}" data-full="${escapeHtml(src)}" alt="" loading="lazy"
                      onerror="this.style.display='none'">`
              ).join('')}</div>`
            : '';

        card.innerHTML = `
            <div class="card-header">
                <span class="rank-badge ${rankClass}">${rankLabel}</span>
                <span class="tag" style="background:${color};">${tag}</span>
                ${hotBadge}
            </div>
            <div class="author-row">
                ${avatarHtml}
                <div class="author-info">
                    <span class="author-name">${escapeHtml(p.author_name)}</span>
                    <span class="author-handle">@${escapeHtml(p.author_username)}</span>
                </div>
                <div class="likes-big">
                    <span class="likes-num">${p.likes.toLocaleString()}</span>
                    <span class="likes-label">â™¡ ã„ã„ã­</span>
                </div>
            </div>
            <div class="text">${escapeHtml(p.text)}</div>
            ${imagesHtml}
            <div class="meta">${dateStr}</div>`;

        container.appendChild(card);
    });
}

function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

function openImageModal(src) {
    if (!imageModalEl || !imageModalImgEl) return;
    imageModalImgEl.src = src;
    imageModalEl.classList.add('show');
    imageModalEl.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    if (!imageModalEl || !imageModalImgEl) return;
    imageModalEl.classList.remove('show');
    imageModalEl.setAttribute('aria-hidden', 'true');
    imageModalImgEl.src = '';
    document.body.style.overflow = '';
}

function initImageModal() {
    imageModalEl = document.getElementById('image-modal');
    imageModalImgEl = document.getElementById('image-modal-img');
    const closeBtn = document.getElementById('image-modal-close');
    const cards = document.getElementById('tweet-cards');
    if (!imageModalEl || !imageModalImgEl || !closeBtn || !cards) return;

    cards.addEventListener('click', (event) => {
        const img = event.target.closest('.tweet-image');
        if (!img) return;
        event.preventDefault();
        event.stopPropagation();
        openImageModal(img.dataset.full || img.src);
    });

    closeBtn.addEventListener('click', closeImageModal);
    imageModalEl.addEventListener('click', (event) => {
        if (event.target === imageModalEl) closeImageModal();
    });
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') closeImageModal();
    });
}

// ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚° =====
async function loadRanking() {
    const HISTORY_URL = 'data/tweets/ranking_history.json';
    let history;
    try {
        const res = await fetch(HISTORY_URL);
        if (!res.ok) return;
        history = await res.json();
    } catch (e) { return; }
    if (!history.length) return;

    const latest = history[history.length - 1];
    const fmtR = iso => { try { return new Date(iso).toLocaleString('ja-JP', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' }); } catch { return iso; } };
    document.getElementById('rnk-update-time').textContent = `æœ€çµ‚æ›´æ–°: ${fmtR(latest.ts)}`;

    const tags = Object.keys(latest.data).sort((a, b) => latest.data[b].total_posts - latest.data[a].total_posts);
    const maxPosts = Math.max(...tags.map(t => latest.data[t].total_posts), 1);
    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
    const rankClasses = ['gold', 'silver', 'bronze', '', ''];
    const list = document.getElementById('rnk-rank-list');
    tags.forEach((tag, i) => {
        const d = latest.data[tag];
        const pct = (d.total_posts / maxPosts * 100).toFixed(1);
        const newBadge = d.new_posts > 0 ? `<span class="rnk-new-badge">+${d.new_posts}</span>` : '';
        const row = document.createElement('div');
        row.className = 'rnk-rank-row';
        row.innerHTML = `
            <div class="rnk-rank-num ${rankClasses[i]}">${medals[i] || i + 1}</div>
            <div class="rnk-rank-info">
                <div class="rnk-rank-tag" style="color:${d.color}">${tag}${newBadge}</div>
                <div class="rnk-bar-wrap"><div class="rnk-bar-fill" style="width:${pct}%;background:${hexToRgba(d.color,0.75)};box-shadow:0 0 6px ${hexToRgba(d.color,0.4)}"></div></div>
                <div class="rnk-rank-meta">ç´¯è¨ˆ <strong>${d.total_posts}</strong> ä»¶</div>
            </div>`;
        list.appendChild(row);
    });

    const canvas = document.getElementById('rnk-trend-canvas');
    const W = canvas.parentElement.clientWidth - 40;
    const H = Math.round(W * 0.4);
    canvas.width = W; canvas.height = H;
    const ctx = canvas.getContext('2d');
    const PAD = { top: 12, right: 10, bottom: 28, left: 48 };
    const plotW = W - PAD.left - PAD.right;
    const plotH = H - PAD.top - PAD.bottom;
    const slice = history.slice(-96);
    const n = slice.length;
    const allVals = slice.flatMap(s => Object.values(s.data).map(d => d.total_posts));
    const yMax = Math.max(...allVals, 1);
    ctx.strokeStyle = chartTheme.gridMinor; ctx.lineWidth = 1;
    [0, 0.25, 0.5, 0.75, 1].forEach(r => {
        const y = PAD.top + plotH * (1 - r);
        ctx.beginPath(); ctx.moveTo(PAD.left, y); ctx.lineTo(PAD.left + plotW, y); ctx.stroke();
        ctx.fillStyle = chartTheme.tick; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
        ctx.fillText(Math.round(yMax * r), PAD.left - 4, y + 3);
    });
    ctx.fillStyle = chartTheme.tick; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    const step = Math.max(1, Math.floor(n / 5));
    for (let i = 0; i < n; i += step) {
        ctx.fillText(fmtR(slice[i].ts), PAD.left + (i / Math.max(n - 1, 1)) * plotW, H - 4);
    }
    tags.forEach(tag => {
        const color = latest.data[tag]?.color || '#888';
        ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
        slice.forEach((snap, i) => {
            const val = snap.data[tag]?.total_posts ?? 0;
            const x = PAD.left + (i / Math.max(n - 1, 1)) * plotW;
            const y = PAD.top + plotH * (1 - val / yMax);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.stroke();
    });
    const legend = document.getElementById('rnk-legend');
    tags.forEach(tag => {
        const color = latest.data[tag]?.color || '#888';
        legend.innerHTML += `<div class="rnk-legend-item"><div class="rnk-legend-dot" style="background:${color}"></div><span>${tag}</span></div>`;
    });

    document.getElementById('rnk-snap-time').textContent = `å–å¾—æ™‚åˆ»: ${fmtR(latest.ts)}`;
    const tbody = document.getElementById('rnk-snap-tbody');
    tags.forEach(tag => {
        const d = latest.data[tag];
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="color:${d.color}">${tag}</td>
            <td><strong>${d.total_posts}</strong></td>
            <td style="color:${d.new_posts > 0 ? '#10b981' : '#475569'}">${d.new_posts > 0 ? '+' + d.new_posts : '-'}</td>`;
        tbody.appendChild(tr);
    });
}

window.onload = () => { init(); loadTweets(); initImageModal(); loadRanking(); };
</script>
</body>
</html>
